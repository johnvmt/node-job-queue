(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.jobsqueue = f()}})(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
function IndexedLinkedList(){this.list={},this.length=0,this.head=null,this.tail=null}IndexedLinkedList.prototype.peek=function(){if(this.length>0)return this.head.data;throw new Error("list_empty")},IndexedLinkedList.prototype.get=function(t){if(this.hasIndex(t))return this.list[t].data;throw new Error("index_undefined")},IndexedLinkedList.prototype.hasIndex=function(t){return"object"==typeof this.list[t]},IndexedLinkedList.prototype.forEach=function(t){for(var e=this.head;null!=e;)t(e.data),e=e.next},IndexedLinkedList.prototype.dequeue=function(){return this._removeItem(this.head)},IndexedLinkedList.prototype.remove=function(t){this._removeItem(this.list[t])},IndexedLinkedList.prototype.push=function(t,e){var i=this._resetIndex(t,e);null!=this.head&&(this.head.prev=i),i.prev=null,i.next=this.head,this.head=i,0==this.length&&(this.tail=i),this.length++},IndexedLinkedList.prototype.enqueue=function(t,e){var i=this._resetIndex(t,e);null!=this.tail&&(this.tail.next=i),i.next=null,i.prev=this.tail,this.tail=i,0==this.length&&(this.head=i),this.length++},IndexedLinkedList.prototype._resetIndex=function(t,e){try{this.remove(t)}catch(t){}return this._set(t,e)},IndexedLinkedList.prototype._set=function(t,e){return"object"==typeof this.list[t]?this.list[t].data=e:this.list[t]={data:e,next:void 0,prev:void 0},this.list[t]},IndexedLinkedList.prototype._removeItem=function(t){if("object"!=typeof t||null==t)throw new Error("undefined_item");return null==t.next?this.tail=t.prev:t.next.prev=t.prev,null==t.prev?this.head=t.next:t.prev.next=t.next,this.length--,t.data},module.exports=function(){return new IndexedLinkedList};
},{}],2:[function(require,module,exports){
function JobsQueue(t){var e={maxSimultaneous:1};this.options=this._objectMerge(e,t),this.queuedJobList=IndexedLinkedList(),this.inprogressJobList=IndexedLinkedList(),this.inprogress=0,this.queued=0}var IndexedLinkedList=require("./IndexedLinkedList");JobsQueue.prototype._tryStartNextJob=function(){function t(t){var o=t.filter(function(t){return e(t)>0});return o.length>0?Math.min.apply(null,o):0}function e(t){return"number"==typeof t&&t>0?t:0}if(this.queuedJobList.length){var o=e(this.options.maxSimultaneous),s=0;this.inprogressJobList.forEach(function(e){s=t([s,e.options.maxSimultaneous])});var i=this.queuedJobList.peek(),r=e(i.options.maxSimultaneous),n=t([o,s,r]);if(n<=0||this.inprogress<n){var u=this.queuedJobList.dequeue();this.queued--,this.inprogressJobList.enqueue(u.jobId,u),this.inprogress++,this._startJob(u.jobId),this._tryStartNextJob()}}},JobsQueue.prototype._startJob=function(t){if(this.inprogressJobList.hasIndex(t)){var e=this.inprogressJobList.get(t),o=e.restarts;e.start(function(){o==e.restarts&&e.controller.complete()})}},JobsQueue.prototype._finishJob=function(t){if(this.inprogressJobList.hasIndex(t))this.inprogressJobList.remove(t),this.inprogress--,this._tryStartNextJob();else{if(!this.queuedJobList.hasIndex(t))throw new Error("job_not_found");this.queuedJobList.remove(t),this.queued--,this._tryStartNextJob()}},JobsQueue.prototype.enqueue=function(t,e){var o=this,s=this._uniqueId(),i={jobId:s,start:t,restarts:0,options:o._objectMerge({},e)},r={cancel:function(){o._finishJob(s)},complete:function(){o._finishJob(s)},restart:function(t){"function"==typeof t&&(i.start=t),i.restarts++,o._startJob(s)}};return i.controller=r,o.queuedJobList.enqueue(s,i),this.queued++,this._tryStartNextJob(),r},JobsQueue.prototype._objectForEach=function(t,e){var o;for(o in t)t.hasOwnProperty(o)&&e(t[o],o,t)},JobsQueue.prototype._objectMerge=function(){var t={};return this._objectForEach(arguments,function(e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])}),t},JobsQueue.prototype._uniqueId=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},module.exports=function(t){return new JobsQueue(t)};
},{"./IndexedLinkedList":1}]},{},[2])(2)
});


//# sourceMappingURL=jobsqueue.js.map